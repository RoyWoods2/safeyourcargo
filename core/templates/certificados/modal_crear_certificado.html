<div class="modal fade" id="modal-certificado" tabindex="-1" aria-labelledby="modalCertificadoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content shadow">

      <style>
        .modal-content {
          font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, sans-serif;
          font-size: 14px;
        }

        .section-container {
          background: #fff;
          border-radius: 8px;
          border: 1px solid #ddd;
          padding: 1.25rem;
          margin-bottom: 1.5rem;
          box-shadow: 0 2px 6px rgba(0,0,0,0.05);
          position: relative;
        }

        .section-container .badge {
          position: absolute;
          top: -0.75rem;
          left: 1rem;
          padding: 0.35em 0.75em;
          font-size: 0.75rem;
          font-weight: 600;
          background-color: #0a8754;
        }

        label {
          font-weight: 600;
          font-size: 13px;
        }

        .form-control, .form-select {
          font-size: 14px;
          padding: 6px 12px;
        }
      </style>

      <div class="modal-header">
        <h5 class="modal-title" id="modalCertificadoLabel">Crear Nuevo Certificado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <form id="form-certificado" method="post">
          {% csrf_token %}

          <!-- INFO GENERAL -->
          <div class="section-container">
            <span class="badge text-white">INFORMACI√ìN GENERAL</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">P√≥liza</label>
                <input type="text" class="form-control bg-light" value="01930324AA" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Compa√±√≠a</label>
                <input type="text" class="form-control bg-light" value="SafeYourCargo" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Cliente</label>
                {{ cert_form.cliente }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha Partida</label>
                {{ cert_form.fecha_partida }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha Llegada</label>
                {{ cert_form.fecha_llegada }}
              </div>
            </div>
          </div>

          <!-- RUTA -->
          <div class="section-container">
            <span class="badge text-white">RUTA</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">Pa√≠s Origen</label>
                {{ ruta_form.pais_origen }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad Origen</label>
                {{ ruta_form.ciudad_origen }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Pa√≠s Destino</label>
                {{ ruta_form.pais_destino }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad Destino</label>
                {{ ruta_form.ciudad_destino }}
              </div>
            </div>
          </div>
<!-- EMBARQUE -->
<div class="section-container">
  <span class="badge text-white">EMBARQUE</span>
  <div class="row mb-3 mt-3">
    <div class="col-md-6">
      <label class="form-label">Modo de Transporte</label>
      <select class="form-select" id="modoTransporte" name="modo_transporte">
        <option value="">Seleccione</option>
        <option value="Aereo">A√©reo</option>
        <option value="Maritimo">Mar√≠timo</option>
        <option value="TerrestreFerroviario">Terrestre / Ferroviario</option>
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Tipo de Carga</label>
      {{ metodo_form.tipo_carga }}
    </div>
    <div class="col-md-6">
      <label class="form-label">Cl√°usula</label>
      {{ metodo_form.clausula }}
    </div>

    <!-- A√âREO -->
    <div class="col-md-6 mt-2 d-none" id="grupo_embalaje_aereo">
      <label class="form-label">Tipo de Embalaje (A√©reo)</label>
      <select class="form-select" id="tipoEmbalajeAereo" name="tipo_embalaje_aereo">
        <option value="">Seleccione una opci√≥n</option>
        <option value="Cajas de Carton">Cajas de Carton</option>
        <option value="Cajas de madera">Cajas de madera</option>
        <option value="Cajas de pl√°stico">Cajas de pl√°stico</option>
        <option value="Pallets">Pallets</option>
        <option value="OTRO">OTRO (especificar)</option>
      </select>
    </div>

    <div class="col-md-6 mt-2 d-none" id="grupo_otro_embalaje_aereo">
      <label class="form-label">Especificar otro tipo de embalaje (A√©reo)</label>
      <input type="text" class="form-control" id="otroEmbalajeAereo" name="otro_embalaje_aereo">
    </div>

    <!-- MAR√çTIMO -->
    <div class="col-md-6 mt-2 d-none" id="grupo_embalaje_maritimo">
      <label class="form-label">Tipo de Embalaje Mar√≠timo</label>
      <select class="form-select" id="embalajeMaritimo" name="embalaje_maritimo">
        <option value="">Seleccione</option>
        <option value="FCL">FCL (Contenedor Completo)</option>
        <option value="LCL">LCL (Carga Suelta)</option>
      </select>
    </div>

    <div class="col-md-6 mt-2 d-none" id="grupo_tipo_container_maritimo">
      <label class="form-label">Tipo de Contenedor (FCL)</label>
      <select class="form-select" id="tipoContainerMaritimo" name="tipo_container_maritimo">
        <option value="">Seleccione</option>
        <option value="DRY">DRY</option>
        <option value="REEFER">REEFER</option>
        <option value="HIGH CUBE">HIGH CUBE</option>
        <option value="OPEN TOP">OPEN TOP</option>
        <option value="FLAT RACK">FLAT RACK</option>
        <option value="FLEX TANK">FLEX TANK</option>
        <option value="ISO TANK">ISO TANK</option>
        <option value="FLEXI TANK">FLEXI TANK</option>
      </select>
    </div>

    <div class="col-md-6 mt-2 d-none" id="grupo_tipo_embalaje_maritimo_lcl">
      <label class="form-label">Tipo de Embalaje (LCL)</label>
      <select class="form-select" id="tipoEmbalajeLCL" name="tipo_embalaje_lcl">
        <option value="">Seleccione</option>
        <option value="Cajas de Carton">Cajas de Carton</option>
        <option value="Cajas de Madera">Cajas de Madera</option>
        <option value="Cajas de Plasticos">Cajas de Pl√°stico</option>
        <option value="Pallets">Pallets</option>
        <option value="OTRO">OTRO (especificar)</option>
      </select>
    </div>

    <div class="col-md-6 mt-2 d-none" id="grupo_otro_embalaje_lcl">
      <label class="form-label">Especificar otro tipo de embalaje (LCL)</label>
      <input type="text" class="form-control" id="otroEmbalajeLCL" name="otro_embalaje_lcl">
    </div>

    <!-- TERRESTRE -->
    <div class="col-md-6 mt-2 d-none" id="grupo_embalaje_terrestre">
      <label class="form-label">Tipo de Embalaje (Terrestre)</label>
      <select class="form-select" id="tipoEmbalajeTerrestre" name="tipo_embalaje_terrestre">
        <option value="">Seleccione una opci√≥n</option>
        <option value="Cajas de Carton">Cajas de Carton</option>
        <option value="Cajas de Madera">Cajas de Madera</option>
        <option value="Cajas de Pl√°stico">Cajas de Pl√°stico</option>
        <option value="Pallets">Pallets</option>
        <option value="OTRO">OTRO (especificar)</option>
      </select>
    </div>

    <div class="col-md-6 mt-2 d-none" id="grupo_otro_embalaje_terrestre">
      <label class="form-label">Especificar otro tipo de embalaje (Terrestre)</label>
      <input type="text" class="form-control" id="otroEmbalajeTerrestre" name="otro_embalaje_terrestre">
    </div>
  </div>
</div>

<!-- VALORES Y PRIMA -->
<div class="section-container">
  <span class="badge text-white">üí∞ VALORES Y PRIMA</span>
  <div class="row mb-3 mt-3">
    
    <!-- Tipo de Mercanc√≠a -->
    <div class="col-md-6">
      <label class="form-label">Tipo de Mercanc√≠a</label>
      {{ mercancia_form.tipo }}
    </div>

    <!-- Valor FCA -->
    <div class="col-md-3">
      <label class="form-label">Valor FCA (USD)</label>
      {{ mercancia_form.valor_fca }}
    </div>

    <!-- Valor Flete -->
    <div class="col-md-3">
      <label class="form-label">Valor Flete (USD)</label>
      {{ mercancia_form.valor_flete }}
    </div>

    <!-- Monto Asegurado (visible) -->
    <div class="col-md-3 mt-3">
      <label class="form-label">Monto Asegurado</label>
      <input type="text" class="form-control" id="montoAsegurado" readonly>
      <input type="hidden" name="monto_asegurado" id="montoAseguradoHidden">
    </div>

    <!-- Cambiar prima manualmente -->
    <div class="col-md-12 mt-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="togglePrima">
        <label class="form-check-label" for="togglePrima">Cambiar prima manualmente</label>
      </div>
    </div>

    <!-- Valor Prima -->
    <div class="col-md-3 mt-2">
      <label class="form-label">Valor Prima (USD)</label>
      {{ mercancia_form.valor_prima }}
    </div>
  </div>

          </div>

          <!-- DETALLE DE VIAJE -->
          <div class="section-container">
            <span class="badge text-white">DETALLES DEL VIAJE</span>
            <div class="row mb-3 mt-3">
<div class="col-md-6">
  <label class="form-label" id="label_nombre_transporte">Nombre Avi√≥n / L√≠nea A√©rea</label>
  {{ viaje_form.nombre_avion }}
</div>

<div class="col-md-6">
  <label class="form-label" id="label_numero_viaje">N¬∞ Viaje / Vuelo</label>
  {{ viaje_form.numero_viaje }}
</div>
              <div class="col-md-6"><label class="form-label">Pa√≠s Origen</label>{{ viaje_form.vuelo_origen_pais }}</div>
              <div class="col-md-6"><label class="form-label">Ciudad Origen</label>{{ viaje_form.vuelo_origen_ciudad }}</div>
              <div class="col-md-6"><label class="form-label">Pa√≠s Destino</label>{{ viaje_form.vuelo_destino_pais }}</div>
              <div class="col-md-6"><label class="form-label">Ciudad Destino</label>{{ viaje_form.vuelo_destino_ciudad }}</div>
<div class="col-md-6" id="grupo_aeropuerto_origen">
  <label class="form-label" id="label_aeropuerto_origen">Aeropuerto Origen</label>
  {{ viaje_form.aeropuerto_origen }}
</div>

<div class="col-md-6" id="grupo_aeropuerto_destino">
  <label class="form-label" id="label_aeropuerto_destino">Aeropuerto Destino</label>
  {{ viaje_form.aeropuerto_destino }}
</div>

              <div class="col-12 mt-2"><label class="form-label">Descripci√≥n</label>{{ viaje_form.descripcion_carga }}</div>
            </div>
          </div>

          <!-- NOTAS -->
          <div class="section-container">
            <span class="badge text-white">NOTAS Y N√öMEROS</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-4"><label class="form-label">Referencia</label>{{ notas_form.referencia }}</div>
              <div class="col-md-4"><label class="form-label">Gu√≠a de Carga</label>{{ notas_form.guia_carga }}</div>
              <div class="col-md-4"><label class="form-label">N¬∞ Factura</label>{{ notas_form.numero_factura }}</div>
              <div class="col-12 mt-2"><label class="form-label">Notas</label>{{ notas_form.notas }}</div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" class="btn btn-primary" form="form-certificado">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
function calcularMontoAsegurado() {
  const fca = parseFloat(document.getElementById("id_valor_fca").value) || 0;
  const flete = parseFloat(document.getElementById("id_valor_flete").value) || 0;
  const asegurado = (fca + flete) * 1.10;

  // Mostrar y actualizar input visible y oculto
  document.getElementById("montoAsegurado").value = asegurado.toFixed(2);
  document.getElementById("montoAseguradoHidden").value = asegurado.toFixed(2);

  const toggle = document.getElementById("togglePrima");
  const primaInput = document.getElementById("id_valor_prima");

  if (!toggle.checked) {
    const calculada = Math.max(asegurado * 0.0015, 20.0);
    primaInput.value = calculada.toFixed(2);
    primaInput.readOnly = true;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  calcularMontoAsegurado();

  document.getElementById("id_valor_fca").addEventListener('input', calcularMontoAsegurado);
  document.getElementById("id_valor_flete").addEventListener('input', calcularMontoAsegurado);

  document.getElementById("togglePrima").addEventListener('change', function () {
    const primaInput = document.getElementById("id_valor_prima");
    primaInput.readOnly = !this.checked;
    if (!this.checked) calcularMontoAsegurado();
  });
});

  document.addEventListener('DOMContentLoaded', () => {
    calcularMontoAsegurado();
    document.getElementById("id_valor_fca").addEventListener('input', calcularMontoAsegurado);
    document.getElementById("id_valor_flete").addEventListener('input', calcularMontoAsegurado);
    document.getElementById("togglePrima").addEventListener('change', () => {
      const primaInput = document.getElementById("id_valor_prima");
      primaInput.readOnly = !document.getElementById("togglePrima").checked;
      if (!document.getElementById("togglePrima").checked) calcularMontoAsegurado();
    });
  });
</script>
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.getElementById("form-certificado").addEventListener("submit", function (e) {
  e.preventDefault();

  const formData = new FormData(this);

  fetch("{% url 'crear_certificado' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken"),
      "X-Requested-With": "XMLHttpRequest"
    },
    body: formData
  })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Certificado creado correctamente.");
            location.reload();
        } else if (data.errors) {
          let mensaje = "Errores en el formulario:\n";
          for (const [formulario, erroresForm] of Object.entries(data.errors)) {
            for (const [campo, listaErrores] of Object.entries(erroresForm)) {
                mensaje += `- ${campo}: ${listaErrores.join(", ")}\n`;
            }
        }
        alert(mensaje);
        }
    })
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const modo = document.getElementById("modoTransporte");

  // A√âREO
  const grupoAereo = document.getElementById("grupo_embalaje_aereo");
  const tipoEmbalajeAereo = document.getElementById("tipoEmbalajeAereo");
  const grupoOtroAereo = document.getElementById("grupo_otro_embalaje_aereo");

  // MAR√çTIMO
  const grupoMaritimo = document.getElementById("grupo_embalaje_maritimo");
  const embalajeMaritimo = document.getElementById("embalajeMaritimo");
  const grupoTipoContenedor = document.getElementById("grupo_tipo_container_maritimo");
  const tipoContainer = document.getElementById("tipoContainerMaritimo");
  const grupoEmbalajeLCL = document.getElementById("grupo_tipo_embalaje_maritimo_lcl");
  const embalajeLCL = document.getElementById("tipoEmbalajeLCL");
  const grupoOtroLCL = document.getElementById("grupo_otro_embalaje_lcl");

  // TERRESTRE
  const grupoTerrestre = document.getElementById("grupo_embalaje_terrestre");
  const tipoEmbalajeTerrestre = document.getElementById("tipoEmbalajeTerrestre");
  const grupoOtroTerrestre = document.getElementById("grupo_otro_embalaje_terrestre");

  function actualizarVistaEmbalaje() {
    const valorModo = modo.value;

    // Reset
    [grupoAereo, grupoOtroAereo, grupoMaritimo, grupoTipoContenedor,
     grupoEmbalajeLCL, grupoOtroLCL, grupoTerrestre, grupoOtroTerrestre].forEach(e => e.classList.add("d-none"));

    if (valorModo === "Aereo") {
      grupoAereo.classList.remove("d-none");
      if (tipoEmbalajeAereo.value === "OTRO") {
        grupoOtroAereo.classList.remove("d-none");
      }
    }

    if (valorModo === "Maritimo") {
      grupoMaritimo.classList.remove("d-none");
      if (embalajeMaritimo.value === "FCL") {
        grupoTipoContenedor.classList.remove("d-none");
      } else if (embalajeMaritimo.value === "LCL") {
        grupoEmbalajeLCL.classList.remove("d-none");
        if (embalajeLCL.value === "OTRO") {
          grupoOtroLCL.classList.remove("d-none");
        }
      }
    }

    if (valorModo === "TerrestreFerroviario") {
      grupoTerrestre.classList.remove("d-none");
      if (tipoEmbalajeTerrestre.value === "OTRO") {
        grupoOtroTerrestre.classList.remove("d-none");
      }
    }
  }

  // Event listeners
  modo.addEventListener("change", actualizarVistaEmbalaje);
  tipoEmbalajeAereo?.addEventListener("change", actualizarVistaEmbalaje);
  embalajeMaritimo?.addEventListener("change", actualizarVistaEmbalaje);
  embalajeLCL?.addEventListener("change", actualizarVistaEmbalaje);
  tipoEmbalajeTerrestre?.addEventListener("change", actualizarVistaEmbalaje);

  actualizarVistaEmbalaje();
});
</script>

