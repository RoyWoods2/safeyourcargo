{% extends 'core/base.html' %}

{% block title %}Dashboard - Safe Your Cargo{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h1 class="mb-4">Dashboard</h1>
  <div class="row g-4">
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="card-title">Certificados</div>
        <div class="card-number text-primary">{{ total_certificados_sum }}</div>
        <div class="text-success small">+2.86% últimos 7 días</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="card-title">Total Primas</div>
        <div class="card-number text-warning">70</div>
        <div class="text-danger small">-0.68% últimos 7 días</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="card-title">Clientes</div>
        <div class="card-number text-danger">{{ certificados_clientes|length }}</div>
        <div class="text-danger small">-8.33% últimos 7 días</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="card-title">Usuarios</div>
        <div class="card-number text-success">1</div>
        <div class="text-success small">+100% últimos 7 días</div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-4">
    <div class="col-md-8">
      <div class="card p-3">
        <h6 class="mb-3">Certificados por Cliente</h6>
        <div id="certificados-chart" style="height:300px;"></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h6 class="mb-3">Origen</h6>
        <div id="origen-map" style="height:300px;"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const certificadosClientes = {{ certificados_clientes|safe }};
  const certificadosTotales = {{ certificados_totales|safe }};
  const origenPaises = {{ origen_paises|safe }};
  const origenCantidades = {{ origen_cantidades|safe }};

  // Gráfico de Certificados por Cliente con labels inclinados
  var certificadosData = {
    x: certificadosClientes,
    y: certificadosTotales,
    type: 'bar',
    marker: { color: '#007bff' }
  };

  var certificadosLayout = {
    margin: { t: 20 },
    yaxis: { title: 'Cantidad de Certificados' },
    xaxis: {
      title: 'Cliente',
      tickangle: -45,
      automargin: true
    },
    plot_bgcolor: '#fff',
    paper_bgcolor: '#fff'
  };

  Plotly.newPlot('certificados-chart', [certificadosData], certificadosLayout);

  // Mapa de Origen
  var origenData = [{
    type: 'choropleth',
    locationmode: 'country names',
    locations: origenPaises,
    z: origenCantidades,
    colorscale: 'Blues',
    reversescale: true,
    marker: { line: { color: 'rgb(180,180,180)', width: 0.5 } },
    colorbar: { title: 'Certificados' }
  }];

  var origenLayout = {
    geo: {
      showframe: false,
      showcoastlines: false,
      projection: { type: 'equirectangular' }
    },
    margin: { t: 0, b: 0 }
  };

  Plotly.newPlot('origen-map', origenData, origenLayout);
</script>
{% endblock %}
